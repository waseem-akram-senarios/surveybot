# ─── Backend Microservices ────────────────────────────────────────────────────

upstream survey_service {
    server survey-service:8020;
    keepalive 8;
}

upstream question_service {
    server question-service:8030;
    keepalive 4;
}

upstream template_service {
    server template-service:8040;
    keepalive 4;
}

upstream voice_service {
    server voice-service:8017;
    keepalive 8;
}

upstream brain_service {
    server brain-service:8016;
    keepalive 8;
}

upstream analytics_service {
    server analytics-service:8060;
    keepalive 4;
}

upstream scheduler_service {
    server scheduler-service:8070;
    keepalive 4;
}

# ─── Frontend Microservices ───────────────────────────────────────────────────

upstream dashboard_app {
    server dashboard:8080;
    keepalive 4;
}

upstream recipient_app {
    server recipient:3000;
    keepalive 4;
}

server {
    listen 8081;
    server_name _;

    # ─── Compression ──────────────────────────────────────────────────────
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 4;
    gzip_min_length 256;
    gzip_types
        application/json
        application/javascript
        text/css
        text/plain
        text/xml
        image/svg+xml;

    # ─── Timeouts ─────────────────────────────────────────────────────────
    proxy_connect_timeout 60s;
    proxy_send_timeout 120s;
    proxy_read_timeout 120s;

    # ─── Keepalive to upstreams ───────────────────────────────────────────
    proxy_http_version 1.1;
    proxy_set_header Connection "";

    # ─── Common proxy headers ─────────────────────────────────────────────
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # ─── Direct call route (skip survey-service hop) ────────────────────
    location = /pg/api/surveys/make-call {
        proxy_pass http://voice_service/api/voice/direct-call;
    }

    # ─── Survey Service ──────────────────────────────────────────────────
    location /pg/api/surveys/ {
        proxy_pass http://survey_service/api/surveys/;
    }
    location = /pg/api/surveys {
        proxy_pass http://survey_service/api/surveys;
    }

    # ─── Answers -> Survey Service ─────────────────────────────────────────
    location /pg/api/answers/ {
        proxy_pass http://survey_service/api/answers/;
    }
    location = /pg/api/answers {
        proxy_pass http://survey_service/api/answers;
    }

    # ─── Question Service ────────────────────────────────────────────────
    location /pg/api/questions/ {
        proxy_pass http://question_service/api/questions/;
    }
    location = /pg/api/questions {
        proxy_pass http://question_service/api/questions;
    }
    location /pg/api/list_questions {
        proxy_pass http://question_service/api/list_questions;
    }

    # ─── Template Service ────────────────────────────────────────────────
    location /pg/api/templates/ {
        proxy_pass http://template_service/api/templates/;
    }
    location = /pg/api/templates {
        proxy_pass http://template_service/api/templates;
    }

    # ─── Brain Service (AI/LLM intelligence) ────────────────────────────
    location /pg/api/brain/ {
        proxy_pass http://brain_service/api/brain/;
    }
    location = /pg/api/brain {
        proxy_pass http://brain_service/api/brain;
    }

    # ─── Voice Service (calls, workflows, transcripts) ────────────────
    location /pg/api/voice/ {
        proxy_pass http://voice_service/api/voice/;
    }
    location = /pg/api/voice {
        proxy_pass http://voice_service/api/voice;
    }

    # ─── Agent compat → voice-service (no separate container needed) ────
    location /pg/api/agent/ {
        proxy_pass http://voice_service/api/agent/;
    }
    location = /pg/api/agent {
        proxy_pass http://voice_service/api/agent;
    }

    # ─── Analytics Service ───────────────────────────────────────────────
    location /pg/api/analytics/ {
        proxy_pass http://analytics_service/api/analytics/;
    }
    location = /pg/api/analytics {
        proxy_pass http://analytics_service/api/analytics;
    }
    location /pg/api/export/ {
        proxy_pass http://analytics_service/api/export/;
    }
    location = /pg/api/export {
        proxy_pass http://analytics_service/api/export;
    }
    location /pg/api/import/ {
        proxy_pass http://analytics_service/api/import/;
    }
    location = /pg/api/import {
        proxy_pass http://analytics_service/api/import;
    }

    # ─── Scheduler Service ───────────────────────────────────────────────
    location /pg/api/scheduler/ {
        proxy_pass http://scheduler_service/api/scheduler/;
    }
    location = /pg/api/scheduler {
        proxy_pass http://scheduler_service/api/scheduler;
    }

    # ─── Recipient App internal API routes ─────────────────────────────────
    location /api/transcribe {
        proxy_pass http://recipient_app/api/transcribe;
        proxy_request_buffering off;
        client_max_body_size 25m;
    }

    # ─── /api/* without /pg prefix (recipient app uses this) ─────────────
    location /api/ {
        rewrite ^/api/(.*)$ /pg/api/$1 last;
    }

    # ─── Recipient App (survey-taking UI) ────────────────────────────────
    location /survey/ {
        proxy_pass http://recipient_app/survey/;
    }
    location /_next/static/ {
        proxy_pass http://recipient_app/_next/static/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    location /_next/ {
        proxy_pass http://recipient_app/_next/;
    }
    location /favicon.ico {
        proxy_pass http://recipient_app/favicon.ico;
        expires 7d;
    }

    # ─── Service health checks via gateway ──────────────────────────────
    location = /pg/api/surveys/health {
        proxy_pass http://survey_service/health;
    }
    location = /pg/api/questions/health {
        proxy_pass http://question_service/health;
    }
    location = /pg/api/templates/health {
        proxy_pass http://template_service/health;
    }
    location = /pg/api/brain/health {
        proxy_pass http://brain_service/health;
    }
    location = /pg/api/voice/health {
        proxy_pass http://voice_service/health;
    }
    location = /pg/api/agent/health {
        proxy_pass http://voice_service/health;
    }
    location = /pg/api/analytics/health {
        proxy_pass http://analytics_service/health;
    }
    location = /pg/api/scheduler/health {
        proxy_pass http://scheduler_service/health;
    }

    # ─── Gateway health check ──────────────────────────────────────────
    location /health {
        return 200 '{"status": "OK", "service": "gateway"}';
        add_header Content-Type application/json;
    }

    # ─── API root fallback ───────────────────────────────────────────────
    location /pg/ {
        proxy_pass http://survey_service/;
    }

    # ─── Dashboard (admin UI) -- root path ───────────────────────────────
    location / {
        proxy_pass http://dashboard_app/;
    }
}
